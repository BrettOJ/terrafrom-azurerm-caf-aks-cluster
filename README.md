
# Creates an Azure AKS cluster

Creates an AKS cluster in the specified region.

Reference the module to a specific version (recommended):

```hcl
module "azurerm_kubernetes_cluster" {

    source  = "aztfmod/terrafrom-caf-aks-cluster/azurerm"
    version = "0.1.0"
  
      name                = var.aks_cluster_name
      convention          = var.naming_convention
      location            = var.location
      resource_group_name = var.rg 
      dns_prefix          = "aks-${var.name}-${local.random}"
      node_resource_group = var.aks_node_rg
      default_node_pool   = var.default_node_pool
      service_principal   = var.service.principal
      tags                = var.tags
}
```

Or get the latest version

```hcl

module "azurerm_kubernetes_cluster" {

    source  = "git://github.com/aztfmod/terrafrom-caf-aks-cluster.git?ref=latest"

      name                = var.aks_cluster_name
      convention          = var.naming_convention
      location            = var.location
      resource_group_name = var.rg 
      dns_prefix          = "aks-${var.name}-${local.random}"
      node_resource_group = var.aks_node_rg
      default_node_pool   = var.default_node_pool
      service_principal   = var.service.principal
      tags                = var.tags
}
}
```

# Parameters

## resource_groups

(Required) Object that describes the resource groups to be created with their geo.
Global group of tags will be added to all RG, specific tags can be added per RG.

```hcl
variable "rg" {
  description = "(Required) Name of the resource group where to create the aks"
  type        = string
}
```
Example
```hcl
name = "rg"
```
## aks_node_rg

(Required) the resourece group for the AKS cluster nodes

```hcl
variable "aks_node_rg" {
  description = "(Required) the resourece group for the AKS cluster nodes"
}
```
Example
```hcl
akaks_node_rg = "akaks_node_rg"
```

## location

(Required) location map of locations to deploy the resources

```hcl
variable "location" {
  description = "(Required) location map of locations to deploy the resources"
}
```
Example
```hcl
location = {
  region1 = "southeastasia"
  region2 = "eastasia"
}

```
## tags

(required) tags map for the tags that will be added to resources in the deployment

```hcl
variable "tags" {
  description = "(required) tags map for the tags that will be added to resources in the deployment"
}
```
Example
```hcl
tags = {
    environment     = "DEV"
    owner           = "BrettOJ"
    deploymentType  = "Terraform"
    costCenter      = "1664"
    BusinessUnit    = "SHARED"
    DR              = "NON-DR-ENABLED"
}
```
## service_principal

(optional) the service principal to be used by the AKS cluster this will be generated by the "aztfmod/terrafrom-caf-service-principal/azurerm" module

```hcl
service_principal = {
    client_id     = "client_id"
    client_secret = "client_secret"
  }
```
Example
```hcl
service_principal = {
    client_id     = "00000000000000000000000000000000"
    client_secret = "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
  }
```
## aks_cluster_name

(required) aks cluster name to be used for the cluster

```hcl
variable  aks_cluster_name" {
  description = "(required) aks cluster name to be used for the cluster"
}
```
Example
```hcl
aks_cluster_name = "test-aks1"
```

## diagnostics_map
(Required) Map with the diagnostics repository information"
```hcl
variable "diagnostics_map" {
 description = "(Required) Map with the diagnostics repository information"
}
```
Example
```hcl
diagnostics_map = {
          diags_sa = "/subscriptions/00000000-0000-0000-0000-00000000/resourceGroups/resource_group_name/providers/Microsoft.Storage/storageAccounts/name_space_storage_account",
          eh_id = "/subscriptions/00000000-0000-0000-0000-00000000/resourceGroups/resource_group_name/providers/Microsoft.EventHub/namespaces/name_space_name",
          eh_name = "name_space_name"
        }
```
## log_analytics_workspace_id
(Required) Log Analytics Workspace details
```hcl
variable "log_analytics_workspace_id" {
  description = "(Required) Log Analytics ID for the AzFW diagnostics"
}
```
Example
```hcl
  log_analytics_workspace_id =  "/subscriptions/00000000-0000-0000-0000-000000000000/resourcegroups/resource_group_name/providers/microsoft.operationalinsights/workspaces/workspace_name"
```

## diag_object
(Required) Map with the settings for diagnostics of the AKS Cluster
```hcl
variable "diag_object" {
 description = "(Required) Map with the diagnostics repository information"
}
```
Example

```hcl
diag_object = {
        log = [
            #["Category name",  "Diagnostics Enabled", "Retention Enabled", Retention period] 
            ["kube-apiserver", true, true, 30],
            ["kube-controller-manager", true, true, 30],
            ["kube-scheduler", true, true, 30],
            ["kube-audit", true, true, 30],
            ["cluster-autoscaler", true, true, 30]
        ]
        metric = [
            ["AllMetrics", true, true, 30],
        ]
}

```
## default_node_pool
(Required)  map object of the settings of the default node pool

```hcl
variable "default_node_pool" {
  description = "(Required)  map object of the settings of the default node pool"
}
```
Example
```hcl
default_node_pool = {
        name = "aksnodepool" 
        vm_size = "Standard_D2_v2"
        node_count = 1
        availability_zones = ""
        enable_auto_scaling = false
        enable_node_public_ip = false
        max_pods = 10
        node_taints = "string"
        os_disk_size_gb = 60
        type = "VirtualMachineScaleSets" # "AvailabilitySet"
        vnet_subnet_id = "string"
        If enable_auto_scaling is set to true, then the following fields can also be configured:
        max_count = 4
        min_count  = 1  
}

```
## convention
(Required) Naming convention to be used.
```hcl
variable "convention" {
  description = "(Required) Naming convention used"
}
```
Example
```hcl
convention = "cafclassic"
```

# Output

| Name | Type | Description | 
| -- | -- | -- | 
| azurerm_kubernetes_cluster | object | Returns the full object of the created AKS Cluster. |
| id | string | Returns the ID of the created AKS Cluster. | 
| kube_config | string | Returns the kube_config of the created AKS Cluster. | 
| client_key | string | Returns the client_key of the created AKS Cluster. | 
| client_certificate | string | Returns the client_certificate of the created AKS Cluster. | 
| cluster_ca_certificate | string | Returns the cluster_ca_certificate of the created AKS Cluster. | 
| host | string | Returns the host of the created AKS Cluster. | 

